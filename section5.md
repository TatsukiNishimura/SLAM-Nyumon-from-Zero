# 第５章

## スキャンマッチングについて

簡単に言えば形合わせ

スキャンしたデータを使ってマッチングする場所を見つけることを

スキャンマッチングという。

## LRF(LiDAR)について

レーザを周囲に照射して２次元的に距離測定をするセンサのこと。

測定方法の原理は

- 時間測定方式

  レーザを照射して跳ね返ってきた時間を計測して距離測定

- 三角測量方式
  受光素子に結像した位置を用いて対象物までの距離を測定

詳しい説明や図は実際の書物参照

## スキャンマッチングのマッチングの仕方について

本書で解説するのは ICP マッチング

他には NDT マッチングも存在する。

## ICP マッチングについて

ICP = Iterative Closest Point

繰り返し計算して一番近い点を見つけるアルゴリズム

流れ

1. 比較対象のデータを用意
2. 測定データと対象データを比較して、１番一致しそうな点を探す。

   その際の評価値には測定データと対象データの対応する部分との総合的な距離となる。

3. 評価値が最小になるのが求める「所」

   本書での所は位置と方向がある

   →(x,y,θ)的な？

## 具体的な計算

次の 2 点を明確にする必要がある。

1.  対象データのどの点と測定データのどの点の距離を計算して合計すればいいのか

    点同士の距離を測るには対象データの対応点、測定データの点 a が必要になる。

2.  点と点の距離を計算するには同じ座標系に要る必要がある → 地図座標系でロボットはどこにいるのか

    ロボット座標系で取得したセンサ情報を地図座標系に変換して、その上でロボットの位置を知る必要がある

これらの回答としては常にロボットの位置を仮ぎめしながら良さそうな解をさがすことで、候補解を求めることである。

### その流れ

1. ロボットの候補位置を適当に決める
2. 測定データの各店の座標をロボットの候補位置にしたがって地図座標に座標変換する
3. 地図座標系での測定データのそれぞれの点に対して対象データの中で一番近い点を選んで対応点とする
4. 測定データの点と対象データの点の対応点との距離を計算する。
5. ロボットの候補位置を少しずらしながら、4.の評価値が最小になる位置を求め、その点の組におけるロボットの位置を仮ぎめする
6. 新しいロボットの仮位置に置いて 1 - 5 を繰り返し行い、評価値を比較。

### 問題点

1. どうやって最初の候補位置を決める？
2. 候補位置のずらし方をどうする？どうやって候補を絞る？
3. 点と点との距離が不均一になる現象について

### 1.の対応

スキャンマッチングの処理ループの 1 周期前の場所から、その次の 1 周期でロボットが移動した分を足し合わせた場所を

初めの候補位置とする。

移動分は移動指令値（速度）を積分する or オドメトリから取得

### 2. の対応

2 重繰り返し処理が使われている。

#### 内側の処理

[この処理](#その流れ)の 2-5 を行うこと

2,3 で決めた対応点を 4 で計算して、5 で位置をずらして繰り返し計算している

#### 外側の処理

内側の処理で計算したロボットの位置を前提として、2,3 で測定データと対象データの対応点を更新し、

その上で 4 の計算を、5 で位置をずらしながら最適解をロボットの位置の次の候補とすること。

外側の処理いる？

→ 内側の処理によってロボットの推定位置が変わる

→ 地図座標系での測定データも変わる

→ 各測定データに一番近い比較対象データの点も変わる

→ ロボットの推定位置を評価する評価関数の値も変わる

### 内側の処理における絞り込みの方法

非線型計画法を用いる。
問題点: 局所最適解に陥ってしまう可能性がある

### 3. の対応

点が密な所において、対応点が同じ点ばかり選ばれてしまうため、測定データを均一化する必要がある。

#### 均一化の方法

仮に、点間隔を L にしたい場合、

1. 隣り合っているスキャンデータ a1 と b の距離を計算する
2. 計算した距離が L より小さい →b を削除し、点 a1 と b の隣のスキャン点 c との距離を計算する
3. a1 との距離が L 以上になるまで削除を繰り返す
4. 距離が L 以上になったら、距離が L のところに a2 を配置する
5. 点 a2 とそれ以降の点により、2-4 と同様な処理を以下の状況になるまで繰り返す
6. あるしきい値 LL を決めておき、4 または 5 において距離が LL より大きいときはそれから 2 点は連続していないとして終了する。

   その後は新たに次の 2 点について 1 から繰り返す

また、地図側でも対策を取る

ロボットが停止している場合、同じスキャンデータを取得してしまい、その部分だけデータ密度が濃くなる。

→ 地図を格子状に区切り、各講師に対して格子を代表する点を作成し、点の密度が均一化するようにすれば良い。
